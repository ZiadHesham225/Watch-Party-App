using Microsoft.AspNetCore.Identity;
using WatchPartyApp.BusinessLogic.Interfaces;
using WatchPartyApp.Data;
using WatchPartyApp.DTOs;
using WatchPartyApp.Models;

namespace WatchPartyApp.BusinessLogic.Services
{
    public class RoomService : IRoomService
    {
        private readonly IUnitOfWork _unitOfWork;
        private readonly UserManager<ApplicationUser> _userManager;
        private readonly ILogger<RoomService> _logger;

        public RoomService(
            IUnitOfWork unitOfWork,
            UserManager<ApplicationUser> userManager,
            ILogger<RoomService> logger)
        {
            _unitOfWork = unitOfWork;
            _userManager = userManager;
            _logger = logger;
        }

        public async Task<Room> CreateRoomAsync(RoomCreateDto roomDto, string userId)
        {
            try
            {
                // Validate input
                if (string.IsNullOrWhiteSpace(roomDto.Name) || string.IsNullOrWhiteSpace(roomDto.VideoUrl))
                {
                    _logger.LogWarning("Room creation failed: Room name and video URL are required");
                    return null;
                }

                var room = new Room
                {
                    Id = Guid.NewGuid().ToString(),
                    Name = roomDto.Name.Trim(),
                    VideoUrl = roomDto.VideoUrl,
                    AdminId = userId,
                    IsActive = true,
                    CreatedAt = DateTime.UtcNow,
                    InviteCode = GenerateInviteCode(),
                    IsPrivate = roomDto.IsPrivate,
                    AllowGuestControl = roomDto.AllowGuestControl,
                    AutoPlay = roomDto.AutoPlay,
                    SyncMode = roomDto.SyncMode ?? "strict",
                    CurrentPosition = 0,
                    IsPlaying = false
                };

                // Handle password for private rooms
                if (roomDto.IsPrivate && !string.IsNullOrEmpty(roomDto.Password))
                {
                    room.PasswordHash = BCrypt.Net.BCrypt.HashPassword(roomDto.Password);
                }

                await _unitOfWork.Rooms.CreateAsync(room);
                await _unitOfWork.SaveAsync();

                return room;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error creating room");
                return null;
            }
        }

        public async Task<Room> GetRoomByIdAsync(string roomId)
        {
            try
            {
                if (string.IsNullOrWhiteSpace(roomId))
                {
                    return null;
                }

                return await _unitOfWork.Rooms.GetByIdAsync(roomId);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting room by ID: {RoomId}", roomId);
                return null;
            }
        }

        public async Task<Room> GetRoomByInviteCodeAsync(string inviteCode)
        {
            try
            {
                if (string.IsNullOrWhiteSpace(inviteCode))
                {
                    return null;
                }

                return await _unitOfWork.Rooms.GetRoomByInviteCodeAsync(inviteCode);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting room by invite code: {InviteCode}", inviteCode);
                return null;
            }
        }

        public async Task<IEnumerable<RoomDto>> GetActiveRoomsAsync()
        {
            try
            {
                var allRooms = await _unitOfWork.Rooms.GetAllAsync();
                var activeRooms = allRooms.Where(r => r.IsActive).ToList();
                
                var result = new List<RoomDto>();
                foreach (var room in activeRooms)
                {
                    var admin = await _userManager.FindByIdAsync(room.AdminId);
                    result.Add(new RoomDto
                    {
                        Id = room.Id,
                        Name = room.Name,
                        VideoUrl = room.VideoUrl,
                        AdminName = admin?.DisplayName ?? admin?.UserName ?? "Unknown",
                        IsActive = room.IsActive,
                        CreatedAt = room.CreatedAt,
                        InviteCode = room.InviteCode,
                        IsPrivate = room.IsPrivate,
                        HasPassword = !string.IsNullOrEmpty(room.PasswordHash),
                        AllowGuestControl = room.AllowGuestControl,
                        UserCount = 0 // Will be populated from in-memory data
                    });
                }
                
                return result;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting active rooms");
                return Enumerable.Empty<RoomDto>();
            }
        }

        public async Task<IEnumerable<RoomDto>> GetUserRoomsAsync(string userId)
        {
            try
            {
                if (string.IsNullOrWhiteSpace(userId))
                {
                    return Enumerable.Empty<RoomDto>();
                }

                var allRooms = await _unitOfWork.Rooms.GetAllAsync();
                var userRooms = allRooms.Where(r => r.AdminId == userId).ToList();
                
                var result = new List<RoomDto>();
                var admin = await _userManager.FindByIdAsync(userId);
                
                foreach (var room in userRooms)
                {
                    result.Add(new RoomDto
                    {
                        Id = room.Id,
                        Name = room.Name,
                        VideoUrl = room.VideoUrl,
                        AdminName = admin?.DisplayName ?? admin?.UserName ?? "Unknown",
                        IsActive = room.IsActive,
                        CreatedAt = room.CreatedAt,
                        InviteCode = room.InviteCode,
                        IsPrivate = room.IsPrivate,
                        HasPassword = !string.IsNullOrEmpty(room.PasswordHash),
                        AllowGuestControl = room.AllowGuestControl,
                        UserCount = 0 // Will be populated from in-memory data
                    });
                }
                
                return result;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting rooms for user: {UserId}", userId);
                return Enumerable.Empty<RoomDto>();
            }
        }

        public async Task<bool> UpdateRoomAsync(RoomUpdateDto roomDto, string userId)
        {
            try
            {
                if (roomDto == null || string.IsNullOrWhiteSpace(roomDto.RoomId) || string.IsNullOrWhiteSpace(userId))
                {
                    return false;
                }

                var room = await _unitOfWork.Rooms.GetByIdAsync(roomDto.RoomId);
                if (room == null || room.AdminId != userId || !room.IsActive)
                {
                    return false;
                }

                // Update properties if provided
                if (!string.IsNullOrWhiteSpace(roomDto.Name))
                {
                    room.Name = roomDto.Name.Trim();
                }

                if (!string.IsNullOrWhiteSpace(roomDto.VideoUrl))
                {
                    room.VideoUrl = roomDto.VideoUrl;
                }

                if (roomDto.IsPrivate.HasValue)
                {
                    room.IsPrivate = roomDto.IsPrivate.Value;
                }

                if (roomDto.AllowGuestControl.HasValue)
                {
                    room.AllowGuestControl = roomDto.AllowGuestControl.Value;
                }

                if (roomDto.AutoPlay.HasValue)
                {
                    room.AutoPlay = roomDto.AutoPlay.Value;
                }

                if (!string.IsNullOrWhiteSpace(roomDto.SyncMode))
                {
                    room.SyncMode = roomDto.SyncMode;
                }

                // Handle password updates
                if (room.IsPrivate && !string.IsNullOrEmpty(roomDto.Password))
                {
                    room.PasswordHash = BCrypt.Net.BCrypt.HashPassword(roomDto.Password);
                }
                else if (!room.IsPrivate)
                {
                    room.PasswordHash = null;
                }

                _unitOfWork.Rooms.Update(room);
                await _unitOfWork.SaveAsync();
                return true;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error updating room: {RoomId}", roomDto?.RoomId);
                return false;
            }
        }

        public async Task<bool> UpdateRoomVideoAsync(string roomId, string videoUrl)
        {
            try
            {
                if (string.IsNullOrWhiteSpace(roomId) || string.IsNullOrWhiteSpace(videoUrl))
                {
                    return false;
                }

                var room = await _unitOfWork.Rooms.GetByIdAsync(roomId);
                if (room == null || !room.IsActive)
                {
                    return false;
                }

                room.VideoUrl = videoUrl;
                room.CurrentPosition = 0; // Reset position when video changes
                room.IsPlaying = false; // Stop playing when video changes

                _unitOfWork.Rooms.Update(room);
                await _unitOfWork.SaveAsync();
                return true;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error updating room video: {RoomId}", roomId);
                return false;
            }
        }

        public async Task<bool> EndRoomAsync(string roomId, string userId)
        {
            try
            {
                if (string.IsNullOrWhiteSpace(roomId) || string.IsNullOrWhiteSpace(userId))
                {
                    return false;
                }

                var room = await _unitOfWork.Rooms.GetByIdAsync(roomId);
                if (room == null || room.AdminId != userId || !room.IsActive)
                {
                    return false;
                }

                room.IsActive = false;
                room.EndedAt = DateTime.UtcNow;
                _unitOfWork.Rooms.Update(room);
                await _unitOfWork.SaveAsync();

                return true;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error ending room: {RoomId}", roomId);
                return false;
            }
        }

        public async Task<bool> UpdatePlaybackStateAsync(string roomId, string userId, double position, bool isPlaying)
        {
            try
            {
                if (string.IsNullOrWhiteSpace(roomId) || position < 0)
                {
                    return false;
                }

                var room = await _unitOfWork.Rooms.GetByIdAsync(roomId);
                if (room == null || !room.IsActive)
                {
                    return false;
                }

                room.CurrentPosition = position;
                room.IsPlaying = isPlaying;

                _unitOfWork.Rooms.Update(room);
                await _unitOfWork.SaveAsync();
                return true;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error updating playback state: Room: {RoomId}", roomId);
                return false;
            }
        }

        public async Task<bool> ValidateRoomPasswordAsync(string roomId, string? password)
        {
            try
            {
                var room = await _unitOfWork.Rooms.GetByIdAsync(roomId);
                if (room == null)
                {
                    return false;
                }

                // If room is not private, no password needed
                if (!room.IsPrivate)
                {
                    return true;
                }

                // If room is private but has no password hash, allow access
                if (string.IsNullOrEmpty(room.PasswordHash))
                {
                    return true;
                }

                // If password is provided, verify it
                if (!string.IsNullOrEmpty(password))
                {
                    return BCrypt.Net.BCrypt.Verify(password, room.PasswordHash);
                }

                // No password provided for private room
                return false;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error validating room password: {RoomId}", roomId);
                return false;
            }
        }

        public async Task<string> GenerateInviteLink(string roomId)
        {
            try
            {
                if (string.IsNullOrWhiteSpace(roomId))
                {
                    return null;
                }

                var room = await _unitOfWork.Rooms.GetByIdAsync(roomId);
                if (room == null || !room.IsActive)
                {
                    return null;
                }
                return $"/watch-party/join/{room.InviteCode}";
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error generating invite link for room: {RoomId}", roomId);
                return null;
            }
        }

        public async Task<bool> IsUserAdminAsync(string roomId, string userId)
        {
            try
            {
                if (string.IsNullOrWhiteSpace(roomId) || string.IsNullOrWhiteSpace(userId))
                {
                    return false;
                }

                var room = await _unitOfWork.Rooms.GetByIdAsync(roomId);
                return room != null && room.AdminId == userId;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error checking if user is admin: {RoomId}, User: {UserId}", roomId, userId);
                return false;
            }
        }

        #region Helper Methods

        private string GenerateInviteCode()
        {
            const string chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
            var random = new Random();
            return new string(Enumerable.Repeat(chars, 8)
                .Select(s => s[random.Next(s.Length)]).ToArray());
        }

        #endregion
    }
}

